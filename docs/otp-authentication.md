# OTP è®¤è¯æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£

## ç‰ˆæœ¬ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**: v4 (æœ€ç»ˆç‰ˆ)
- **åˆ›å»ºæ—¥æœŸ**: 2025-01-15
- **é€‚ç”¨fsshç‰ˆæœ¬**: v2.0+

---

## ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [è®¤è¯æ¨¡å‹](#è®¤è¯æ¨¡å‹)
3. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
4. [å®‰å…¨æ€§åˆ†æ](#å®‰å…¨æ€§åˆ†æ)
5. [ç”¨æˆ·ä½¿ç”¨æŒ‡å—](#ç”¨æˆ·ä½¿ç”¨æŒ‡å—)
6. [é…ç½®å‚è€ƒ](#é…ç½®å‚è€ƒ)
7. [å‘½ä»¤è¡Œæ¥å£](#å‘½ä»¤è¡Œæ¥å£)
8. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)

---

## æ¦‚è¿°

### æ–¹æ¡ˆèƒŒæ™¯

fssh ç›®å‰ä½¿ç”¨ Touch ID è®¤è¯ä¿æŠ¤ SSH ç§é’¥ã€‚ç„¶è€Œï¼Œéƒ¨åˆ† macOS è®¾å¤‡ä¸æ”¯æŒ Touch IDï¼ˆå¦‚ Mac Miniã€è€æ¬¾ MacBookã€è™šæ‹Ÿæœºç­‰ï¼‰ã€‚OTPï¼ˆOne-Time Passwordï¼‰è®¤è¯æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªåŸºäºå¯†ç å’Œ TOTP éªŒè¯ç çš„æ›¿ä»£è®¤è¯æ–¹å¼ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **åŒå±‚å®‰å…¨æ¶æ„**: å¯†ç ä¿æŠ¤ OTP seed + TOTP åŠ¨æ€éªŒè¯ç 
- **çµæ´»çš„ç¼“å­˜ç­–ç•¥**: å¯é…ç½® OTP seed å’Œ Master Key çš„ç¼“å­˜å‘¨æœŸ
- **æ¢å¤ç æœºåˆ¶**: é˜²æ­¢ä¸¢å¤±è®¤è¯å™¨æ—¶æ— æ³•è®¿é—®
- **ä¸ Touch ID å¹¶è¡Œ**: ç”¨æˆ·å¯æ ¹æ®è®¾å¤‡èƒ½åŠ›é€‰æ‹©è®¤è¯æ–¹å¼
- **æ ‡å‡†å…¼å®¹**: ä½¿ç”¨ RFC 6238 TOTP æ ‡å‡†ï¼Œå…¼å®¹å„ç±»è®¤è¯å™¨åº”ç”¨

### è®¤è¯æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | Touch ID æ¨¡å¼ | OTP æ¨¡å¼ |
|-----|--------------|---------|
| **è®¾å¤‡è¦æ±‚** | éœ€ Touch ID/Face ID ç¡¬ä»¶ | ä»»æ„ Mac |
| **è§£é”æ–¹å¼** | ç”Ÿç‰©ç‰¹å¾ï¼ˆæŒ‡çº¹/é¢å®¹ï¼‰ | å¯†ç  + TOTP éªŒè¯ç  |
| **å®‰å…¨æ€§** | ç¡¬ä»¶çº§ä¿æŠ¤ + Keychain | PBKDF2 + AES-256 + TOTP |
| **è·¨è®¾å¤‡è¿ç§»** | âŒ (Keychain ç»‘å®šè®¾å¤‡) | âœ… (å¯å¯¼å‡ºé…ç½®) |
| **ç¦»çº¿å¯ç”¨** | âœ… | âœ… |
| **é€‚ç”¨åœºæ™¯** | ä¸ªäºº MacBook/iMac | æœåŠ¡å™¨ã€è™šæ‹Ÿæœºã€æ—§æ¬¾ Mac |

---

## è®¤è¯æ¨¡å‹

### åŒå±‚å®‰å…¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: å¯†ç è§£é” OTP seed (é•¿æœŸä¿æŠ¤)                     â”‚
â”‚   ç”¨æˆ·è¾“å…¥å¯†ç  â†’ PBKDF2(100kè¿­ä»£) â†’ AES-256-GCMè§£å¯†      â”‚
â”‚   â†’ è·å– OTP seed â†’ ç¼“å­˜åˆ°å†…å­˜ (TTL: seed_unlock_ttl)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: TOTP éªŒè¯ç éªŒè¯ (åŠ¨æ€è®¤è¯)                      â”‚
â”‚   ç”¨æˆ·è¾“å…¥éªŒè¯ç  â†’ éªŒè¯ TOTP(seed, code)                â”‚
â”‚   â†’ ä» seed æ´¾ç”Ÿ Master Key â†’ ç¼“å­˜ (TTL: unlock_ttl)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: ç§é’¥è§£å¯†å’Œç­¾å                                  â”‚
â”‚   Master Key â†’ HKDF æ´¾ç”Ÿæ–‡ä»¶å¯†é’¥ â†’ AES-256-GCM è§£å¯†ç§é’¥  â”‚
â”‚   â†’ SSH ç­¾å â†’ è¿”å›å®¢æˆ·ç«¯                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥ä½œæµç¨‹è¯¦è§£

#### 1. Agent å¯åŠ¨æ—¶ / OTP seed ç¼“å­˜è¿‡æœŸ

```
ç”¨æˆ·: fssh agent
  â†“
æç¤ºè¾“å…¥å¯†ç : ****************
  â†“
PBKDF2(password, salt, 100000, SHA-256) â†’ è§£å¯†å¯†é’¥
  â†“
AES-256-GCM è§£å¯† OTP seed
  â†“
ç¼“å­˜ seed åˆ°å†…å­˜ (æœ‰æ•ˆæœŸ: seed_unlock_ttl_seconds)
  â†“
æç¤ºè¾“å…¥éªŒè¯ç : 123456
  â†“
éªŒè¯ TOTP(seed, code) â†’ æˆåŠŸ
  â†“
HKDF(seed, salt, info) â†’ Master Key
  â†“
ç¼“å­˜ Master Key (æœ‰æ•ˆæœŸ: unlock_ttl_seconds)
  â†“
Agent å¯åŠ¨å®Œæˆ
```

#### 2. SSH è¿æ¥æ—¶ (Master Key åœ¨ç¼“å­˜æœŸå†…)

```
ç”¨æˆ·: ssh user@server
  â†“
SSH å®¢æˆ·ç«¯è¯·æ±‚ç­¾å
  â†“
æ£€æŸ¥ Master Key ç¼“å­˜ â†’ å‘½ä¸­
  â†“
ç›´æ¥ä½¿ç”¨ Master Key è§£å¯†ç§é’¥å¹¶ç­¾å
  â†“
è¿æ¥å»ºç«‹
```

#### 3. SSH è¿æ¥æ—¶ (Master Key è¿‡æœŸï¼Œseed åœ¨ç¼“å­˜æœŸå†…)

```
ç”¨æˆ·: ssh user@server
  â†“
æ£€æŸ¥ Master Key ç¼“å­˜ â†’ è¿‡æœŸ
  â†“
æ£€æŸ¥ OTP seed ç¼“å­˜ â†’ å‘½ä¸­
  â†“
æç¤ºè¾“å…¥éªŒè¯ç : 789012
  â†“
éªŒè¯ TOTP(ç¼“å­˜çš„seed, code) â†’ æˆåŠŸ
  â†“
æ´¾ç”Ÿæ–°çš„ Master Key å¹¶ç¼“å­˜
  â†“
è§£å¯†ç§é’¥å¹¶ç­¾å
  â†“
è¿æ¥å»ºç«‹
```

#### 4. SSH è¿æ¥æ—¶ (seed ç¼“å­˜è¿‡æœŸ)

```
ç”¨æˆ·: ssh user@server
  â†“
æ£€æŸ¥ OTP seed ç¼“å­˜ â†’ è¿‡æœŸ
  â†“
æç¤ºè¾“å…¥å¯†ç : ****************
  â†“
è§£å¯† OTP seed å¹¶ç¼“å­˜
  â†“
æç¤ºè¾“å…¥éªŒè¯ç : 456789
  â†“
éªŒè¯ TOTP å¹¶æ´¾ç”Ÿ Master Key
  â†“
è§£å¯†ç§é’¥å¹¶ç­¾å
  â†“
è¿æ¥å»ºç«‹
```

---

## æŠ€æœ¯æ¶æ„

### æ•°æ®ç»“æ„

#### OTP é…ç½®æ–‡ä»¶ (`~/.fssh/otp/config.enc`)

```json
{
    "version": "fssh-otp/v1",
    "algorithm": "SHA1",
    "digits": 6,
    "period": 30,

    "encrypted_seed": "base64-encoded-ciphertext",
    "seed_salt": "base64-32-bytes",
    "seed_nonce": "base64-12-bytes",

    "master_key_salt": "base64-32-bytes",

    "seed_unlock_ttl_seconds": 3600,

    "recovery_codes_hash": [
        "sha256-hash-1",
        "sha256-hash-2",
        "..."
    ],

    "created_at": "2025-01-15T10:30:00Z"
}
```

**å­—æ®µè¯´æ˜:**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| `version` | string | é…ç½®ç‰ˆæœ¬æ ‡è¯† |
| `algorithm` | string | TOTP ç®—æ³•: SHA1/SHA256/SHA512 |
| `digits` | int | éªŒè¯ç ä½æ•°: 6 æˆ– 8 |
| `period` | int | TOTP æ—¶é—´çª—å£ï¼ˆç§’ï¼‰ï¼Œæ ‡å‡†ä¸º 30 |
| `encrypted_seed` | string | AES-256-GCM åŠ å¯†çš„ OTP seed (base64) |
| `seed_salt` | string | PBKDF2 ä½¿ç”¨çš„ salt (base64, 32å­—èŠ‚) |
| `seed_nonce` | string | AES-GCM ä½¿ç”¨çš„ nonce (base64, 12å­—èŠ‚) |
| `master_key_salt` | string | HKDF æ´¾ç”Ÿ Master Key çš„ salt (base64, 32å­—èŠ‚) |
| `seed_unlock_ttl_seconds` | int | OTP seed ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ |
| `recovery_codes_hash` | array | æ¢å¤ç çš„ SHA-256 å“ˆå¸Œæ•°ç»„ |

#### è¿è¡Œæ—¶çŠ¶æ€ (å†…å­˜ä¸­)

```go
type OTPProvider struct {
    configPath string
    config     *otp.Config

    // OTP seed ç¼“å­˜
    mu         sync.Mutex
    cachedSeed []byte      // è§£å¯†åçš„ OTP seed
    seedExpiry time.Time   // seed ç¼“å­˜è¿‡æœŸæ—¶é—´

    // Master key ç¼“å­˜
    cachedMasterKey []byte
    masterKeyExpiry time.Time
    masterKeyTTL    int
}
```

### å¯†ç å­¦è®¾è®¡

#### 1. OTP Seed åŠ å¯†

```
ç”¨æˆ·å¯†ç  (string)
  â†“
PBKDF2-HMAC-SHA256(password, salt, 100000 iterations) â†’ 32å­—èŠ‚è§£å¯†å¯†é’¥
  â†“
AES-256-GCM.Encrypt(è§£å¯†å¯†é’¥, nonce, OTP_seed, AAD=nil) â†’ å¯†æ–‡
  â†“
Base64ç¼–ç  â†’ å­˜å‚¨åˆ° config.enc
```

**å‚æ•°é€‰æ‹©:**
- **PBKDF2 è¿­ä»£æ¬¡æ•°**: 100,000 (OWASP 2023 æ¨èæœ€å°å€¼)
- **Salt é•¿åº¦**: 32 å­—èŠ‚ (256 bits)
- **AES æ¨¡å¼**: GCM (Galois/Counter Mode) æä¾›è®¤è¯åŠ å¯†
- **Nonce é•¿åº¦**: 12 å­—èŠ‚ (GCM æ ‡å‡†æ¨è)

#### 2. Master Key æ´¾ç”Ÿ

```
OTP seed (20å­—èŠ‚) + Master Key Salt (32å­—èŠ‚)
  â†“
HKDF-SHA256(seed, salt, info="fssh-master-key-v1", length=32)
  â†“
32å­—èŠ‚ Master Key
```

**HKDF æµç¨‹:**
```
1. Extract: PRK = HMAC-SHA256(salt, OTP_seed)
2. Expand:
   T(0) = ""
   T(1) = HMAC-SHA256(PRK, T(0) || info || 0x01)
   T(2) = HMAC-SHA256(PRK, T(1) || info || 0x02)
   ...
   Output = first 32 bytes of (T(1) || T(2) || ...)
```

#### 3. TOTP éªŒè¯

```go
func Verify(seed []byte, userCode string, algorithm string, digits int, period int) bool {
    now := time.Now().Unix()
    counter := now / int64(period)

    // å…è®¸ Â±1 ä¸ªæ—¶é—´çª—å£ï¼ˆÂ±30ç§’å®¹é”™ï¼‰
    for offset := int64(-1); offset <= 1; offset++ {
        expected := GenerateTOTP(seed, counter+offset, algorithm, digits)
        if userCode == expected {
            return true
        }
    }
    return false
}

func GenerateTOTP(seed []byte, counter int64, algorithm string, digits int) string {
    // HOTP ç®—æ³• (RFC 4226)
    h := hmac.New(sha1.New, seed)
    binary.Write(h, binary.BigEndian, counter)
    hash := h.Sum(nil)

    // Dynamic truncation
    offset := hash[len(hash)-1] & 0x0f
    code := binary.BigEndian.Uint32(hash[offset:offset+4]) & 0x7fffffff
    code = code % uint32(math.Pow10(digits))

    return fmt.Sprintf("%0*d", digits, code)
}
```

**æ—¶é—´çª—å£å®¹é”™:**
- å½“å‰æ—¶é—´çª—å£: `Tâ‚€ = Unix_Time / 30`
- éªŒè¯èŒƒå›´: `[Tâ‚€-1, Tâ‚€, Tâ‚€+1]` (è¦†ç›– Â±30 ç§’)
- é˜²æ­¢æ—¶é’Ÿåç§»å¯¼è‡´çš„éªŒè¯å¤±è´¥

### æ–‡ä»¶ç³»ç»Ÿå®‰å…¨

```bash
~/.fssh/
â”œâ”€â”€ config.json              # æƒé™: 0644 (å…¨å±€é…ç½®)
â”œâ”€â”€ auth_mode.json           # æƒé™: 0644 (è®¤è¯æ¨¡å¼æ ‡è¯†)
â”œâ”€â”€ agent.sock               # æƒé™: 0600 (Unix socket)
â”œâ”€â”€ otp/
â”‚   â””â”€â”€ config.enc           # æƒé™: 0600 (ä»…å½“å‰ç”¨æˆ·è¯»å†™)
â””â”€â”€ keys/
    â”œâ”€â”€ myserver.enc         # æƒé™: 0600
    â””â”€â”€ github.enc           # æƒé™: 0600
```

**å®‰å…¨æªæ–½:**
- æ‰€æœ‰æ•æ„Ÿæ–‡ä»¶æƒé™è®¾ç½®ä¸º `0600`
- ä¾èµ– macOS FileVault å…¨ç›˜åŠ å¯†ä¿æŠ¤é™æ€æ•°æ®
- è¿›ç¨‹é—´é€šè¿‡ Unix socket é€šä¿¡ï¼ˆæƒé™æ§åˆ¶ï¼‰

---

## å®‰å…¨æ€§åˆ†æ

### å¨èƒæ¨¡å‹

#### æ”»å‡»åœºæ™¯çŸ©é˜µ

| æ”»å‡»åœºæ™¯ | æ”»å‡»è€…éœ€è¦ | é˜²æŠ¤æªæ–½ | é£é™©ç­‰çº§ |
|---------|-----------|---------|---------|
| **ç£ç›˜è¢«ç›—** | ç‰©ç†è®¾å¤‡ | FileVaultåŠ å¯† + config.encæƒé™0600 | ğŸŸ¢ ä½ |
| **é…ç½®æ–‡ä»¶æ³„éœ²** | config.encæ–‡ä»¶ | PBKDF2 100kè¿­ä»£ + å¼ºå¯†ç è¦æ±‚ | ğŸŸ¡ ä¸­ |
| **å¯†ç æ³„éœ²** | OTPå¯†ç  | ä»éœ€TOTPéªŒè¯ç ï¼ˆ30ç§’è¿‡æœŸï¼‰ | ğŸŸ¡ ä¸­ |
| **éªŒè¯ç æ‹¦æˆª** | å½“å‰éªŒè¯ç  | éœ€è¦å¯†ç è§£é”seed | ğŸŸ¢ ä½ |
| **seed + éªŒè¯ç åŒæ—¶æ³„éœ²** | ç¼“å­˜çš„seed + å½“å‰éªŒè¯ç  | å¯åœ¨30ç§’å†…è§£å¯†ç§é’¥ | ğŸ”´ é«˜ |
| **å†…å­˜dump** | rootæƒé™ + TTLçª—å£ | è®¾ç½®seed_unlock_ttl=0 | ğŸŸ¡ ä¸­ |
| **ç¦»çº¿æš´åŠ›ç ´è§£å¯†ç ** | config.enc | PBKDF2å‡ç¼“ï¼ˆ~10ç§’/å°è¯•ï¼‰ | ğŸŸ¢ ä½ |
| **Keylogger** | è®°å½•å¯†ç å’ŒéªŒè¯ç  | ç‰©ç†å®‰å…¨/ç³»ç»Ÿå®‰å…¨èŒƒç•´ | ğŸ”´ é«˜ |

#### é˜²æŠ¤å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L5: ç‰©ç†å®‰å…¨                                            â”‚
â”‚   - è®¾å¤‡ç‰©ç†è®¿é—®æ§åˆ¶                                    â”‚
â”‚   - é˜²æ­¢ Keylogger/Screen capture                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L4: æ“ä½œç³»ç»Ÿå®‰å…¨                                        â”‚
â”‚   - FileVault å…¨ç›˜åŠ å¯†                                 â”‚
â”‚   - æ–‡ä»¶ç³»ç»Ÿæƒé™ (0600)                                â”‚
â”‚   - è¿›ç¨‹éš”ç¦»å’Œæƒé™ç®¡ç†                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3: å¯†ç å­¦ä¿æŠ¤                                          â”‚
â”‚   - PBKDF2 100k è¿­ä»£                                   â”‚
â”‚   - AES-256-GCM è®¤è¯åŠ å¯†                               â”‚
â”‚   - HKDF å¯†é’¥æ´¾ç”Ÿ                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L2: åŠ¨æ€è®¤è¯                                            â”‚
â”‚   - TOTP 30ç§’æ—¶æ•ˆéªŒè¯ç                                 â”‚
â”‚   - æ—¶é—´çª—å£å®¹é”™ (Â±30ç§’)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L1: ç¼“å­˜ç®¡ç†                                            â”‚
â”‚   - TTL æ—¶é—´é™åˆ¶                                        â”‚
â”‚   - å†…å­˜æ•æ„Ÿæ•°æ®æ¸…é›¶                                    â”‚
â”‚   - å¯é…ç½®ç¼“å­˜ç­–ç•¥                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯†ç å­¦å¼ºåº¦è¯„ä¼°

#### PBKDF2 æš´åŠ›ç ´è§£æ—¶é—´ä¼°ç®—

å‡è®¾æ”»å‡»è€…ä½¿ç”¨é«˜ç«¯ GPU (NVIDIA RTX 4090):
- PBKDF2-SHA256 æ€§èƒ½: ~100,000 æ¬¡/ç§’
- æ¯æ¬¡å°è¯•æ—¶é—´: ~0.01 ç§’

| å¯†ç å¼ºåº¦ | ç»„åˆæ•° | ç ´è§£æ—¶é—´ (å•GPU) |
|---------|-------|----------------|
| 8ä½çº¯æ•°å­— | 10â¸ | 16 åˆ†é’Ÿ |
| 8ä½å­—æ¯+æ•°å­— | 62â¸ | 7,000 å¹´ |
| 12ä½å­—æ¯+æ•°å­— | 62Â¹Â² | 1.4Ã—10â¹ å¹´ |
| 16ä½éšæœº | 62Â¹â¶ | 1.3Ã—10Â¹â¸ å¹´ |

**æ¨è:**
- æœ€å°é•¿åº¦: 12 ä½
- ç»„æˆ: å¤§å°å†™å­—æ¯ + æ•°å­— + ç¬¦å·
- ä½¿ç”¨å¯†ç ç®¡ç†å™¨ç”Ÿæˆå’Œå­˜å‚¨

#### TOTP å®‰å…¨æ€§

- **æ—¶é—´çª—å£**: 30 ç§’
- **éªŒè¯ç ç©ºé—´**: 10â¶ (6ä½æ•°å­—)
- **æš´åŠ›ç ´è§£æ¦‚ç‡**:
  - å•æ¬¡å°è¯•: 1/1,000,000
  - 3ä¸ªçª—å£å†…: 3/1,000,000
- **é™æµä¿æŠ¤**: å»ºè®®æ·»åŠ å¤±è´¥é™æµï¼ˆæœªå®ç°ï¼‰

### é…ç½®å®‰å…¨ç­‰çº§

#### æè‡´å®‰å…¨é…ç½®

```json
{
    "seed_unlock_ttl_seconds": 0,
    "unlock_ttl_seconds": 0,
    "require_auth_per_sign": true
}
```

**ç‰¹ç‚¹:**
- âœ… å†…å­˜ä¸­ä¸ç¼“å­˜æ•æ„Ÿæ•°æ®
- âœ… æ¯æ¬¡ SSH éƒ½éœ€è¦å¯†ç  + éªŒè¯ç 
- âŒ ç”¨æˆ·ä½“éªŒå·®

**é€‚ç”¨åœºæ™¯:** é«˜åº¦æ•æ„Ÿç¯å¢ƒï¼ˆé‡‘èã€å†›äº‹ã€å…³é”®åŸºç¡€è®¾æ–½ï¼‰

#### å¹³è¡¡é…ç½®ï¼ˆæ¨èï¼‰

```json
{
    "seed_unlock_ttl_seconds": 3600,
    "unlock_ttl_seconds": 600,
    "require_auth_per_sign": true
}
```

**ç‰¹ç‚¹:**
- âœ… 1å°æ—¶è¾“å…¥1æ¬¡å¯†ç 
- âœ… 10åˆ†é’Ÿå†…å…éªŒè¯ç 
- âœ… å®‰å…¨æ€§å’Œä½“éªŒå¹³è¡¡

**é€‚ç”¨åœºæ™¯:** æ—¥å¸¸å¼€å‘å·¥ä½œï¼Œä¼ä¸šç¯å¢ƒ

#### ä¾¿åˆ©é…ç½®

```json
{
    "seed_unlock_ttl_seconds": 86400,
    "unlock_ttl_seconds": 3600,
    "require_auth_per_sign": false
}
```

**ç‰¹ç‚¹:**
- âœ… æ¥è¿‘ Touch ID ä½“éªŒ
- âœ… Agent å¯åŠ¨æ—¶è®¤è¯ä¸€æ¬¡
- âš ï¸ 24å°æ—¶å†… seed ä¿ç•™åœ¨å†…å­˜

**é€‚ç”¨åœºæ™¯:** ä¸ªäººå¼€å‘ç¯å¢ƒï¼Œå·²å¯ç”¨ FileVault

### æ¢å¤ç æœºåˆ¶

#### ç”Ÿæˆå’Œå­˜å‚¨

```go
// ç”Ÿæˆ10ä¸ªæ¢å¤ç 
func generateRecoveryCodes() []string {
    codes := make([]string, 10)
    for i := 0; i < 10; i++ {
        // æ ¼å¼: XXXX-XXXX-XXXX-XXXX
        codes[i] = generateRandomAlphaNumeric(16, "-", 4)
    }
    return codes
}

// å­˜å‚¨ SHA-256 å“ˆå¸Œ
func storeRecoveryCodes(codes []string) []string {
    hashes := make([]string, len(codes))
    for i, code := range codes {
        hash := sha256.Sum256([]byte(code))
        hashes[i] = hex.EncodeToString(hash[:])
    }
    return hashes
}
```

#### ä½¿ç”¨æµç¨‹

```
ç”¨æˆ·: fssh otp-recover
  â†“
æç¤ºè¾“å…¥å¯†ç : ****************
  â†“
æç¤ºè¾“å…¥æ¢å¤ç : A3F9-2K8H-9D4L-6M2P
  â†“
è®¡ç®— SHA-256(recovery_code)
  â†“
å¯¹æ¯” config.recovery_codes_hash
  â†“
éªŒè¯æˆåŠŸ â†’ è§£é” OTP seed
  â†“
æ ‡è®°è¯¥æ¢å¤ç ä¸ºå·²ä½¿ç”¨ï¼ˆä»æ•°ç»„åˆ é™¤hashï¼‰
  â†“
æç¤ºå‰©ä½™æ¢å¤ç æ•°é‡
```

**å®‰å…¨ç‰¹æ€§:**
- æ¯ä¸ªæ¢å¤ç ä»…å¯ä½¿ç”¨ä¸€æ¬¡
- å­˜å‚¨å“ˆå¸Œè€Œéæ˜æ–‡ï¼ˆé˜²æ­¢æ³„éœ²ï¼‰
- ä½¿ç”¨åç«‹å³å¤±æ•ˆ

---

## ç”¨æˆ·ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### 1. æ£€æŸ¥è®¾å¤‡èƒ½åŠ›

```bash
$ fssh auth-status

è®¤è¯èƒ½åŠ›æ£€æµ‹
============
Touch ID: ä¸æ”¯æŒ âŒ
å»ºè®®ä½¿ç”¨: OTP è®¤è¯æ¨¡å¼
```

#### 2. åˆå§‹åŒ– OTP æ¨¡å¼

```bash
$ fssh init --mode otp

åˆå§‹åŒ– OTP è®¤è¯æ¨¡å¼

è¯·è®¾ç½® OTP å¯†ç ï¼ˆè‡³å°‘12ä½ï¼‰: ****************
ç¡®è®¤å¯†ç : ****************

æ­£åœ¨ç”Ÿæˆ OTP seed...

è¯·ä½¿ç”¨è®¤è¯å™¨åº”ç”¨æ‰«æäºŒç»´ç ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–ˆâ–ˆâ–ˆâ–ˆ â–„â–„â–„â–„ â–ˆâ–ˆâ–€â–€ â–„â–„â–„â–„ â–ˆâ–ˆâ–ˆâ–ˆ          â”‚
â”‚  ... QR Code ...                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æˆ–æ‰‹åŠ¨æ·»åŠ åˆ° Google Authenticator / Authy:
  å‘è¡Œè€…: fssh
  è´¦æˆ·: leo@MacBook-Pro
  å¯†é’¥: JBSWY3DPEHPK3PXP
  ç±»å‹: åŸºäºæ—¶é—´
  ç®—æ³•: SHA1
  ä½æ•°: 6
  é—´éš”: 30ç§’

æ¢å¤ç ï¼ˆè¯·å®‰å…¨ä¿å­˜ï¼Œæ‰“å°æˆ–å­˜å…¥å¯†ç ç®¡ç†å™¨ï¼‰ï¼š
  1. A3F9-2K8H-9D4L-6M2P
  2. B7K3-9F2H-4L8D-3M9K
  3. C5M2-8K9H-3L6D-7P4F
  4. D8K6-3H2M-9L4D-5P8K
  5. E2P9-7K4H-6L3D-9M5K
  6. F9M3-5K8H-2L7D-4P6K
  7. G4K7-9H3M-8L2D-6P9K
  8. H8P2-4K6H-7L9D-3M8K
  9. J3M6-8K2H-5L4D-9P7K
 10. K7P4-2K9H-6L8D-3M5K

âœ“ OTP è®¤è¯å·²åˆå§‹åŒ–
âœ“ OTP seed è§£é”å‘¨æœŸ: 3600ç§’ï¼ˆ1å°æ—¶ï¼‰
âœ“ é…ç½®å·²ä¿å­˜åˆ° ~/.fssh/otp/config.enc

âš ï¸  å®‰å…¨æç¤ºï¼š
  1. è¯·å¯ç”¨ FileVault å…¨ç›˜åŠ å¯†
  2. å»ºè®®åœ¨ç¬¬äºŒå°è®¾å¤‡ä¹Ÿæ·»åŠ æ­¤ OTPï¼ˆæ‰«æç›¸åŒäºŒç»´ç ï¼‰
  3. å¦¥å–„ä¿ç®¡æ¢å¤ç ï¼Œä¸¢å¤±æ— æ³•æ‰¾å›

ä¸‹ä¸€æ­¥ï¼š
  fssh import -alias myserver -file ~/.ssh/id_rsa
```

#### 3. å¯¼å…¥ SSH ç§é’¥

```bash
$ fssh import -alias myserver -file ~/.ssh/id_rsa

è¯·è¾“å…¥ OTP å¯†ç : ****************
è¯·è¾“å…¥6ä½éªŒè¯ç : 123456
âœ“ éªŒè¯æˆåŠŸ

æ­£åœ¨åŠ å¯†ç§é’¥...
âœ“ ç§é’¥ 'myserver' å·²å¯¼å…¥
```

#### 4. å¯åŠ¨ Agent

```bash
$ fssh agent

fssh SSH è®¤è¯ä»£ç†
================

è®¤è¯æ¨¡å¼: OTP
Master key ç¼“å­˜: 600ç§’

OTP è®¤è¯åˆå§‹åŒ–
==============
è¯·è¾“å…¥ OTP å¯†ç : ****************
è¯·è¾“å…¥6ä½éªŒè¯ç : 789012

âœ“ OTP seed å·²è§£é”ï¼ˆç¼“å­˜æœ‰æ•ˆæœŸ: 3600ç§’ï¼‰
âœ“ TOTP éªŒè¯æˆåŠŸ
âœ“ Agent å·²å¯åŠ¨

[INFO] Socket: /Users/leo/.fssh/agent.sock
[INFO] å·²åŠ è½½ 3 ä¸ªç§é’¥
[INFO] OTP seed å°†åœ¨ 2025-01-15 11:30:00 è¿‡æœŸ
```

#### 5. ä½¿ç”¨ SSH

```bash
# ç¬¬ä¸€æ¬¡è¿æ¥ï¼ˆåœ¨ TTL ç¼“å­˜æœŸå†…ï¼‰
$ ssh user@server
# ç›´æ¥è¿æ¥ï¼Œæ— éœ€è¾“å…¥

# TTL è¿‡æœŸå
$ ssh user@server2
è¯·è¾“å…¥6ä½éªŒè¯ç : 456789
âœ“ éªŒè¯æˆåŠŸ
[SSH è¿æ¥å»ºç«‹...]

# seed TTL è¿‡æœŸå
$ ssh user@server3
OTP seed ç¼“å­˜å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°è§£é”
è¯·è¾“å…¥ OTP å¯†ç : ****************
âœ“ OTP seed å·²è§£é”

è¯·è¾“å…¥6ä½éªŒè¯ç : 321654
âœ“ éªŒè¯æˆåŠŸ
[SSH è¿æ¥å»ºç«‹...]
```

### å¸¸ç”¨æ“ä½œ

#### æŸ¥çœ‹çŠ¶æ€

```bash
$ fssh otp-status

OTP è®¤è¯é…ç½®
===========
è®¤è¯æ¨¡å¼: OTP
ç®—æ³•: SHA1
ä½æ•°: 6
æ—¶é—´é—´éš”: 30ç§’

ç¼“å­˜é…ç½®:
  OTP seed è§£é”å‘¨æœŸ: 3600ç§’ï¼ˆ1å°æ—¶ï¼‰
  Master key ç¼“å­˜: 600ç§’ï¼ˆ10åˆ†é’Ÿï¼‰

å½“å‰çŠ¶æ€:
  OTP seed: å·²è§£é” âœ“ï¼ˆå‰©ä½™ 2847ç§’ï¼‰
  Master key: å·²ç¼“å­˜ âœ“ï¼ˆå‰©ä½™ 456ç§’ï¼‰

å®‰å…¨æ£€æŸ¥:
  âœ“ é…ç½®æ–‡ä»¶æƒé™: 0600
  âœ— FileVault çŠ¶æ€: æœªå¯ç”¨ï¼ˆå¼ºçƒˆå»ºè®®å¯ç”¨ï¼‰
  âœ“ å‰©ä½™æ¢å¤ç : 10ä¸ª

é…ç½®æ–‡ä»¶: /Users/leo/.fssh/otp/config.enc
```

#### ä¿®æ”¹é…ç½®

```bash
# ä¿®æ”¹ seed è§£é”å‘¨æœŸä¸º 2 å°æ—¶
$ fssh otp-config --seed-unlock-ttl 7200
âœ“ OTP seed è§£é”å‘¨æœŸå·²æ›´æ–°ä¸º 7200ç§’ï¼ˆ2å°æ—¶ï¼‰
âœ“ è¯·é‡å¯ agent ä»¥åº”ç”¨æ›´æ”¹

# ä¿®æ”¹ master key ç¼“å­˜æ—¶é—´
$ fssh otp-config --master-key-ttl 1800
âœ“ Master key ç¼“å­˜å·²æ›´æ–°ä¸º 1800ç§’ï¼ˆ30åˆ†é’Ÿï¼‰
```

#### æ˜¾ç¤º OTP è®¾ç½®

```bash
$ fssh otp-show

OTP è®¾ç½®ä¿¡æ¯
===========

è¯·æ‰«æäºŒç»´ç æ·»åŠ åˆ°æ–°è®¾å¤‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–ˆâ–ˆâ–ˆâ–ˆ â–„â–„â–„â–„ â–ˆâ–ˆâ–€â–€ â–„â–„â–„â–„ â–ˆâ–ˆâ–ˆâ–ˆ          â”‚
â”‚  ... QR Code ...                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰‹åŠ¨æ·»åŠ ä¿¡æ¯ï¼š
  å‘è¡Œè€…: fssh
  è´¦æˆ·: leo@MacBook-Pro
  å¯†é’¥: JBSWY3DPEHPK3PXP
  ç±»å‹: åŸºäºæ—¶é—´
  ç®—æ³•: SHA1
  ä½æ•°: 6
  é—´éš”: 30ç§’

å½“å‰éªŒè¯ç : 789012 (å‰©ä½™ 18ç§’)

âš ï¸  è­¦å‘Š: è¯·å‹¿ä¸ä»–äººåˆ†äº«æ­¤ä¿¡æ¯
```

#### æ›´æ”¹å¯†ç 

```bash
$ fssh otp-change-password

æ›´æ”¹ OTP å¯†ç 
============

è¯·è¾“å…¥å½“å‰å¯†ç : ****************
è¯·è¾“å…¥éªŒè¯ç : 123456
âœ“ éªŒè¯æˆåŠŸ

è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘12ä½ï¼‰: ****************
ç¡®è®¤æ–°å¯†ç : ****************

æ­£åœ¨é‡æ–°åŠ å¯† OTP seed...
âœ“ å¯†ç å·²æ›´æ–°
âœ“ OTP seed å·²ç”¨æ–°å¯†ç é‡æ–°åŠ å¯†
âœ“ é…ç½®å·²ä¿å­˜

å»ºè®®é‡å¯ agent: pkill -f 'fssh agent' && fssh agent &
```

#### æ¸…é™¤ç¼“å­˜

```bash
$ fssh otp-lock

âœ“ å·²æ¸…é™¤ OTP seed ç¼“å­˜
âœ“ å·²æ¸…é™¤ Master key ç¼“å­˜
âœ“ ä¸‹æ¬¡ä½¿ç”¨æ—¶éœ€è¦é‡æ–°è¾“å…¥å¯†ç å’ŒéªŒè¯ç 
```

#### æ¢å¤ç ç®¡ç†

```bash
# æŸ¥çœ‹å‰©ä½™æ¢å¤ç æ•°é‡
$ fssh otp-recovery-status
å‰©ä½™æ¢å¤ç : 8/10

# é‡æ–°ç”Ÿæˆæ¢å¤ç ï¼ˆéœ€éªŒè¯ï¼‰
$ fssh otp-recovery-regenerate

è¯·è¾“å…¥ OTP å¯†ç : ****************
è¯·è¾“å…¥éªŒè¯ç : 123456
âœ“ éªŒè¯æˆåŠŸ

æ–°çš„æ¢å¤ç ï¼ˆè¯·é‡æ–°ä¿å­˜ï¼‰ï¼š
  1. M9K3-7H2P-4L6D-8K5M
  2. N2P8-5K4H-9L3D-6M7K
  ... (10ä¸ªæ–°æ¢å¤ç )

âš ï¸  æ—§çš„æ¢å¤ç å·²å…¨éƒ¨å¤±æ•ˆ

# ä½¿ç”¨æ¢å¤ç ç™»å½•
$ fssh otp-recover

OTP seed æ¢å¤
============

æ— æ³•ç”Ÿæˆ TOTP éªŒè¯ç ï¼Ÿä½¿ç”¨æ¢å¤ç ç™»å½•ã€‚

è¯·è¾“å…¥ OTP å¯†ç : ****************
è¯·è¾“å…¥æ¢å¤ç : A3F9-2K8H-9D4L-6M2P

éªŒè¯æ¢å¤ç ...
âœ“ æ¢å¤ç æœ‰æ•ˆï¼ˆè¯¥ç å·²ä½œåºŸï¼‰
âœ“ OTP seed å·²è§£é”

å‰©ä½™æ¢å¤ç : 9ä¸ª
å»ºè®®é‡æ–°ç”Ÿæˆæ¢å¤ç : fssh otp-recovery-regenerate
```

### æ•…éšœæ’é™¤

#### éªŒè¯ç æ€»æ˜¯é”™è¯¯

```bash
# 1. æ£€æŸ¥ç³»ç»Ÿæ—¶é—´
$ date
Tue Jan 15 10:30:45 CST 2025

# 2. æµ‹è¯•éªŒè¯ç 
$ fssh otp-verify 123456
âœ— éªŒè¯ç é”™è¯¯

å½“å‰æœåŠ¡å™¨æ—¶é—´: 2025-01-15 10:30:50
æ—¶é—´åç§»: 0 ç§’

å¯èƒ½åŸå› :
  - è®¤è¯å™¨åº”ç”¨æ—¶é—´ä¸åŒæ­¥
  - è®¤è¯å™¨åº”ç”¨é…ç½®é”™è¯¯ï¼ˆç®—æ³•ã€ä½æ•°ã€é—´éš”ï¼‰
  - æ‰‹åŠ¨è¾“å…¥å¯†é’¥æ—¶å‡ºé”™

å»ºè®®:
  1. åœ¨è®¤è¯å™¨åº”ç”¨ä¸­é‡æ–°æ‰«æäºŒç»´ç : fssh otp-show
  2. ç¡®ä¿è®¤è¯å™¨åº”ç”¨æ—¶é—´ä¸ç³»ç»Ÿæ—¶é—´ä¸€è‡´
  3. å°è¯•ä½¿ç”¨æ¢å¤ç : fssh otp-recover
```

#### å¿˜è®° OTP å¯†ç 

```bash
# å¦‚æœæœ‰æ¢å¤ç ï¼Œå¯ä»¥é‡ç½®å¯†ç 
$ fssh otp-reset-password

âš ï¸  æ­¤æ“ä½œéœ€è¦æ¢å¤ç éªŒè¯

è¯·è¾“å…¥æ¢å¤ç : A3F9-2K8H-9D4L-6M2P
âœ“ æ¢å¤ç éªŒè¯æˆåŠŸ

è¯·è¾“å…¥æ–°å¯†ç : ****************
ç¡®è®¤æ–°å¯†ç : ****************

âœ“ å¯†ç å·²é‡ç½®
âœ“ OTP seed å·²ç”¨æ–°å¯†ç é‡æ–°åŠ å¯†

# å¦‚æœæ²¡æœ‰æ¢å¤ç ï¼Œåªèƒ½é‡æ–°åˆå§‹åŒ–ï¼ˆä¼šä¸¢å¤±ç°æœ‰ç§é’¥è®¿é—®æƒé™ï¼‰
$ fssh init --mode otp --force
âš ï¸  è­¦å‘Š: æ­¤æ“ä½œå°†åˆ é™¤ç°æœ‰ OTP é…ç½®
âš ï¸  æ‰€æœ‰å¯¼å…¥çš„ç§é’¥å°†æ— æ³•è§£å¯†
âš ï¸  è¯·ç¡®ä¿å·²å¤‡ä»½ç§é’¥åŸå§‹æ–‡ä»¶

ç¡®è®¤é‡æ–°åˆå§‹åŒ–? (yes/no):
```

#### Agent å¯åŠ¨å¤±è´¥

```bash
$ fssh agent
é”™è¯¯: OTP é…ç½®æ–‡ä»¶æŸå

# æ£€æŸ¥é…ç½®æ–‡ä»¶
$ cat ~/.fssh/otp/config.enc
{
  "version": "fssh-otp/v1",
  ... (æ£€æŸ¥ JSON æ ¼å¼)
}

# éªŒè¯é…ç½®æ–‡ä»¶æƒé™
$ ls -la ~/.fssh/otp/config.enc
-rw-------  1 leo  staff  1234 Jan 15 10:30 config.enc

# å¦‚æœé…ç½®æŸåï¼Œå°è¯•ä»å¤‡ä»½æ¢å¤
$ fssh otp-import --input backup.enc
```

---

## é…ç½®å‚è€ƒ

### å…¨å±€é…ç½®æ–‡ä»¶ (`~/.fssh/config.json`)

```json
{
    "socket": "~/.fssh/agent.sock",
    "require_auth_per_sign": true,
    "unlock_ttl_seconds": 600,
    "log_level": "info",
    "log_format": "plain",
    "log_out": "",
    "log_err": ""
}
```

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|-------|------|
| `socket` | string | `~/.fssh/agent.sock` | SSH agent socket è·¯å¾„ |
| `require_auth_per_sign` | bool | `true` | æ˜¯å¦æ¯æ¬¡ç­¾åéƒ½éœ€è¦è®¤è¯ |
| `unlock_ttl_seconds` | int | `600` | Master key ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ |
| `log_level` | string | `info` | æ—¥å¿—çº§åˆ«: debug/info/warn/error |
| `log_format` | string | `plain` | æ—¥å¿—æ ¼å¼: plain/json |
| `log_out` | string | `""` | æ ‡å‡†è¾“å‡ºæ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆç©º=stdoutï¼‰ |
| `log_err` | string | `""` | é”™è¯¯è¾“å‡ºæ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆç©º=stderrï¼‰ |

### OTP é…ç½®æ–‡ä»¶ (`~/.fssh/otp/config.enc`)

è¯¦è§ [æ•°æ®ç»“æ„](#æ•°æ®ç»“æ„) ç« èŠ‚ã€‚

### é…ç½®é¢„è®¾æ–¹æ¡ˆ

#### æè‡´å®‰å…¨

```json
{
    "require_auth_per_sign": true,
    "unlock_ttl_seconds": 0,
    "otp": {
        "seed_unlock_ttl_seconds": 0
    }
}
```

**ç‰¹ç‚¹:** æ¯æ¬¡ SSH éƒ½è¾“å…¥å¯†ç  + éªŒè¯ç 

#### å¹³è¡¡é…ç½®ï¼ˆæ¨èï¼‰

```json
{
    "require_auth_per_sign": true,
    "unlock_ttl_seconds": 600,
    "otp": {
        "seed_unlock_ttl_seconds": 3600
    }
}
```

**ç‰¹ç‚¹:** 1å°æ—¶è¾“å…¥1æ¬¡å¯†ç ï¼Œ10åˆ†é’Ÿå†…å…éªŒè¯ç 

#### ä¾¿åˆ©ä¼˜å…ˆ

```json
{
    "require_auth_per_sign": false,
    "unlock_ttl_seconds": 3600,
    "otp": {
        "seed_unlock_ttl_seconds": 86400
    }
}
```

**ç‰¹ç‚¹:** Agent å¯åŠ¨æ—¶è®¤è¯ï¼Œ24å°æ—¶å†…æ— éœ€é‡æ–°è®¤è¯

---

## å‘½ä»¤è¡Œæ¥å£

### åˆå§‹åŒ–å’Œæ¨¡å¼ç®¡ç†

```bash
# åˆå§‹åŒ– OTP æ¨¡å¼
fssh init --mode otp [OPTIONS]
  --seed-unlock-ttl SECONDS   # OTP seed è§£é”å‘¨æœŸï¼ˆé»˜è®¤ 3600ï¼‰
  --algorithm SHA1|SHA256     # TOTP ç®—æ³•ï¼ˆé»˜è®¤ SHA1ï¼‰
  --digits 6|8                # éªŒè¯ç ä½æ•°ï¼ˆé»˜è®¤ 6ï¼‰
  --period SECONDS            # TOTP æ—¶é—´çª—å£ï¼ˆé»˜è®¤ 30ï¼‰

# ç¤ºä¾‹
fssh init --mode otp --seed-unlock-ttl 7200 --algorithm SHA256 --digits 8

# æŸ¥çœ‹è®¤è¯æ¨¡å¼å’ŒçŠ¶æ€
fssh auth-status

# åˆ‡æ¢è®¤è¯æ¨¡å¼
fssh switch-to-otp          # Touch ID â†’ OTP
fssh switch-to-touchid      # OTP â†’ Touch ID
```

### OTP é…ç½®ç®¡ç†

```bash
# æŸ¥çœ‹ OTP çŠ¶æ€ï¼ˆå«ç¼“å­˜çŠ¶æ€ï¼‰
fssh otp-status

# æ˜¾ç¤º OTP è®¾ç½®ï¼ˆQR ç å’Œæ‰‹åŠ¨é…ç½®ï¼‰
fssh otp-show

# ä¿®æ”¹é…ç½®
fssh otp-config --seed-unlock-ttl SECONDS
fssh otp-config --algorithm SHA1|SHA256|SHA512
fssh otp-config --digits 6|8

# æ›´æ”¹å¯†ç 
fssh otp-change-password

# æ¸…é™¤ç¼“å­˜ï¼ˆå¼ºåˆ¶é‡æ–°è®¤è¯ï¼‰
fssh otp-lock

# æµ‹è¯•éªŒè¯ç 
fssh otp-verify CODE
```

### æ¢å¤å’Œå¤‡ä»½

```bash
# æŸ¥çœ‹æ¢å¤ç çŠ¶æ€
fssh otp-recovery-status

# æ˜¾ç¤ºæ¢å¤ç ï¼ˆéœ€éªŒè¯ï¼‰
fssh otp-recovery-show

# é‡æ–°ç”Ÿæˆæ¢å¤ç ï¼ˆæ—§ç å¤±æ•ˆï¼‰
fssh otp-recovery-regenerate

# ä½¿ç”¨æ¢å¤ç ç™»å½•
fssh otp-recover

# é‡ç½®å¯†ç ï¼ˆä½¿ç”¨æ¢å¤ç ï¼‰
fssh otp-reset-password

# å¯¼å‡º OTP é…ç½®ï¼ˆåŠ å¯†å¤‡ä»½ï¼‰
fssh otp-export --output backup.enc

# å¯¼å…¥ OTP é…ç½®
fssh otp-import --input backup.enc
```

### Agent ç®¡ç†

```bash
# å¯åŠ¨ agent
fssh agent [OPTIONS]
  --unlock-ttl-seconds SECONDS  # Master key ç¼“å­˜æ—¶é—´

# æŸ¥çœ‹ agent çŠ¶æ€
fssh status

# åœæ­¢ agent
pkill -f 'fssh agent'

# é‡å¯ agent
pkill -f 'fssh agent' && fssh agent &
```

---

## å®æ–½è®¡åˆ’

### å¼€å‘é˜¶æ®µ

#### Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡:** å®ç° OTP æ¨¡å¼çš„åŸºæœ¬è®¤è¯æµç¨‹

- [ ] `internal/auth` æ¨¡å—
  - [ ] `AuthProvider` æ¥å£å®šä¹‰
  - [ ] `OTPProvider` å®ç°
  - [ ] `TouchIDProvider` é‡æ„
  - [ ] è®¤è¯æ¨¡å¼ç®¡ç†
- [ ] `internal/otp` æ¨¡å—
  - [ ] TOTP ç”Ÿæˆå’ŒéªŒè¯
  - [ ] OTP é…ç½®åŠ è½½/ä¿å­˜
  - [ ] å¯†ç å’ŒéªŒè¯ç è¾“å…¥æç¤º
- [ ] `cmd/fssh` å‘½ä»¤
  - [ ] `init --mode otp`
  - [ ] `otp-status`
  - [ ] `otp-verify`
- [ ] é›†æˆåˆ° Agent
  - [ ] `server.go` ä½¿ç”¨ `AuthProvider`
  - [ ] `secure_agent.go` æ”¯æŒ OTP
  - [ ] seed å’Œ master key ç¼“å­˜é€»è¾‘

**éªŒæ”¶æ ‡å‡†:**
```bash
fssh init --mode otp
fssh import -alias test -file ~/.ssh/id_rsa
fssh agent
ssh test@server  # æˆåŠŸè¿æ¥
```

#### Phase 2: ç”¨æˆ·ä½“éªŒï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡:** å®Œå–„ç”¨æˆ·äº¤äº’å’Œé…ç½®ç®¡ç†

- [ ] QR ç ç”Ÿæˆå’Œæ˜¾ç¤º
- [ ] æ¢å¤ç æœºåˆ¶
  - [ ] ç”Ÿæˆå’Œå­˜å‚¨
  - [ ] éªŒè¯å’Œä½¿ç”¨
  - [ ] é‡æ–°ç”Ÿæˆ
- [ ] é…ç½®ç®¡ç†å‘½ä»¤
  - [ ] `otp-config`
  - [ ] `otp-change-password`
  - [ ] `otp-lock`
  - [ ] `otp-show`
- [ ] é”™è¯¯æç¤ºä¼˜åŒ–
- [ ] æ—¶é—´åŒæ­¥æ£€æŸ¥

**éªŒæ”¶æ ‡å‡†:**
```bash
fssh otp-show  # æ˜¾ç¤º QR ç 
fssh otp-recover  # æ¢å¤ç ç™»å½•æˆåŠŸ
fssh otp-config --seed-unlock-ttl 7200  # é…ç½®ä¿®æ”¹æˆåŠŸ
```

#### Phase 3: é«˜çº§ç‰¹æ€§ï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡:** å®Œå–„å®‰å…¨æ€§å’Œè¿ç§»åŠŸèƒ½

- [ ] Touch ID â†” OTP æ¨¡å¼åˆ‡æ¢
  - [ ] `switch-to-otp`
  - [ ] `switch-to-touchid`
  - [ ] ç§é’¥é‡æ–°åŠ å¯†
- [ ] é…ç½®å¯¼å‡º/å¯¼å…¥
  - [ ] `otp-export`
  - [ ] `otp-import`
  - [ ] åŠ å¯†å¤‡ä»½
- [ ] å®‰å…¨æ£€æŸ¥
  - [ ] FileVault çŠ¶æ€æ£€æµ‹
  - [ ] é…ç½®æ–‡ä»¶æƒé™æ£€æŸ¥
  - [ ] å¯†ç å¼ºåº¦éªŒè¯
- [ ] æ–‡æ¡£å’Œç¤ºä¾‹

**éªŒæ”¶æ ‡å‡†:**
```bash
fssh switch-to-otp  # Touch ID â†’ OTP æˆåŠŸ
fssh otp-export --output backup.enc  # å¤‡ä»½æˆåŠŸ
fssh otp-import --input backup.enc  # æ¢å¤æˆåŠŸ
```

### æµ‹è¯•è®¡åˆ’

#### å•å…ƒæµ‹è¯•

- [ ] `internal/otp/totp_test.go`
  - TOTP ç”Ÿæˆå’ŒéªŒè¯
  - æ—¶é—´çª—å£å®¹é”™
  - ä¸åŒç®—æ³•æµ‹è¯•
- [ ] `internal/auth/otp_test.go`
  - seed åŠ å¯†/è§£å¯†
  - master key æ´¾ç”Ÿ
  - ç¼“å­˜é€»è¾‘
- [ ] `internal/otp/recovery_test.go`
  - æ¢å¤ç ç”Ÿæˆ
  - æ¢å¤ç éªŒè¯

#### é›†æˆæµ‹è¯•

- [ ] OTP åˆå§‹åŒ–æµç¨‹
- [ ] Agent å¯åŠ¨å’Œè®¤è¯
- [ ] SSH è¿æ¥ï¼ˆä¸åŒ TTL é…ç½®ï¼‰
- [ ] æ¨¡å¼åˆ‡æ¢
- [ ] é…ç½®å¯¼å‡º/å¯¼å…¥

#### å…¼å®¹æ€§æµ‹è¯•

| è®¾å¤‡ | Touch ID | OTP | æµ‹è¯•ç»“æœ |
|-----|----------|-----|---------|
| MacBook Pro 2023 | âœ… | âœ… | |
| MacBook Pro 2015 | âŒ | âœ… | |
| Mac Mini 2023 | âŒ | âœ… | |
| macOS VM (Parallels) | âŒ | âœ… | |
| Hackintosh | âŒ | âœ… | |

#### å®‰å…¨æµ‹è¯•

- [ ] é…ç½®æ–‡ä»¶æƒé™éªŒè¯
- [ ] å¯†ç æš´åŠ›ç ´è§£æµ‹è¯•ï¼ˆPBKDF2 æ€§èƒ½ï¼‰
- [ ] å†…å­˜æ³„æ¼æ£€æŸ¥ï¼ˆæ•æ„Ÿæ•°æ®æ¸…é›¶ï¼‰
- [ ] TOTP æ—¶é—´åŒæ­¥æµ‹è¯•

### å‘å¸ƒè®¡åˆ’

#### v2.0-beta1
- Phase 1 æ ¸å¿ƒåŠŸèƒ½
- åŸºæœ¬æ–‡æ¡£
- å†…éƒ¨æµ‹è¯•

#### v2.0-beta2
- Phase 2 ç”¨æˆ·ä½“éªŒ
- å®Œæ•´æ–‡æ¡£
- å…¬å¼€æµ‹è¯•ï¼ˆé‚€è¯·ç”¨æˆ·ï¼‰

#### v2.0-rc1
- Phase 3 é«˜çº§ç‰¹æ€§
- ä¿®å¤ beta é˜¶æ®µé—®é¢˜
- æ€§èƒ½ä¼˜åŒ–

#### v2.0 æ­£å¼ç‰ˆ
- å®Œæ•´åŠŸèƒ½
- ç”Ÿäº§å°±ç»ª
- å‘å¸ƒå…¬å‘Š

---

## é™„å½•

### A. è®¤è¯å™¨åº”ç”¨æ¨è

| åº”ç”¨ | å¹³å° | å¤‡ä»½ | å¤šè®¾å¤‡åŒæ­¥ | æ¨èåº¦ |
|-----|------|-----|-----------|-------|
| Google Authenticator | iOS/Android | âœ… (äº‘å¤‡ä»½) | âœ… | â­â­â­â­ |
| Authy | iOS/Android/Desktop | âœ… (äº‘å¤‡ä»½) | âœ… | â­â­â­â­â­ |
| 1Password | å¤šå¹³å° | âœ… | âœ… | â­â­â­â­â­ |
| Microsoft Authenticator | iOS/Android | âœ… | âœ… | â­â­â­â­ |
| FreeOTP | iOS/Android | âŒ | âŒ | â­â­â­ |

**æ¨è:** Authyï¼ˆæ”¯æŒå¤šè®¾å¤‡åŒæ­¥ä¸”å…è´¹ï¼‰

### B. å¯†ç ç­–ç•¥å»ºè®®

**æœ€å°è¦æ±‚:**
- é•¿åº¦: â‰¥12 ä½
- ç»„æˆ: å¤§å°å†™å­—æ¯ + æ•°å­—

**æ¨è:**
- é•¿åº¦: â‰¥16 ä½
- ç»„æˆ: å¤§å°å†™å­—æ¯ + æ•°å­— + ç¬¦å·
- ä½¿ç”¨å¯†ç ç®¡ç†å™¨ç”Ÿæˆ
- ä¸è¦ä½¿ç”¨ä¸ªäººä¿¡æ¯ï¼ˆç”Ÿæ—¥ã€å§“åç­‰ï¼‰

**ç¤ºä¾‹ï¼ˆä½¿ç”¨ pwgenï¼‰:**
```bash
$ pwgen -s -y 16 1
aK9#mP2$xL7@qR4%
```

### C. FileVault é…ç½®æŒ‡å—

```bash
# æ£€æŸ¥ FileVault çŠ¶æ€
$ fdesetup status
FileVault is Off.

# å¯ç”¨ FileVaultï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
$ sudo fdesetup enable
Enter the user name:leo
Enter the password for user 'leo':

A recovery key has been generated:
XXXX-XXXX-XXXX-XXXX-XXXX-XXXX

# éªŒè¯çŠ¶æ€
$ fdesetup status
FileVault is On.
```

**æˆ–é€šè¿‡å›¾å½¢ç•Œé¢:**
1. ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§
2. FileVault æ ‡ç­¾é¡µ
3. ç‚¹å‡» "æ‰“å¼€ FileVault"
4. é€‰æ‹©æ¢å¤æ–¹å¼ï¼ˆiCloud æˆ–æ¢å¤å¯†é’¥ï¼‰
5. é‡å¯åŠ å¯†

### D. æ•…éšœæ’é™¤æ£€æŸ¥æ¸…å•

é—®é¢˜ï¼šéªŒè¯ç æ€»æ˜¯é”™è¯¯
- [ ] æ£€æŸ¥ç³»ç»Ÿæ—¶é—´: `date`
- [ ] æ£€æŸ¥è®¤è¯å™¨åº”ç”¨æ—¶é—´
- [ ] éªŒè¯ OTP é…ç½®: `fssh otp-show`
- [ ] é‡æ–°æ‰«æ QR ç 
- [ ] å°è¯•ä½¿ç”¨æ¢å¤ç 

é—®é¢˜ï¼šå¿˜è®° OTP å¯†ç 
- [ ] å°è¯•ä½¿ç”¨æ¢å¤ç é‡ç½®: `fssh otp-reset-password`
- [ ] å¦‚æ— æ¢å¤ç ï¼Œåªèƒ½é‡æ–°åˆå§‹åŒ–ï¼ˆä¼šä¸¢å¤±ç§é’¥è®¿é—®æƒé™ï¼‰
- [ ] ä»ç§é’¥åŸå§‹æ–‡ä»¶é‡æ–°å¯¼å…¥

é—®é¢˜ï¼šAgent å¯åŠ¨å¤±è´¥
- [ ] æ£€æŸ¥é…ç½®æ–‡ä»¶: `cat ~/.fssh/otp/config.enc`
- [ ] æ£€æŸ¥æ–‡ä»¶æƒé™: `ls -la ~/.fssh/otp/`
- [ ] æ£€æŸ¥æ—¥å¿—: `fssh agent --log-level debug`
- [ ] å°è¯•ä»å¤‡ä»½æ¢å¤: `fssh otp-import`

é—®é¢˜ï¼šSSH è¿æ¥å¾ˆæ…¢
- [ ] æ£€æŸ¥ TTL é…ç½®ï¼ˆå¯èƒ½è¿‡çŸ­å¯¼è‡´é¢‘ç¹è®¤è¯ï¼‰
- [ ] å¢åŠ  `unlock_ttl_seconds`
- [ ] å¢åŠ  `seed_unlock_ttl_seconds`
- [ ] æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿï¼ˆä¸ OTP æ— å…³ï¼‰

### E. å‚è€ƒèµ„æ–™

- [RFC 4226: HOTP](https://datatracker.ietf.org/doc/html/rfc4226)
- [RFC 6238: TOTP](https://datatracker.ietf.org/doc/html/rfc6238)
- [RFC 5869: HKDF](https://datatracker.ietf.org/doc/html/rfc5869)
- [OWASP Password Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)
- [NIST SP 800-63B: Digital Identity Guidelines](https://pages.nist.gov/800-63-3/sp800-63b.html)

---

## ç‰ˆæœ¬å†å²

- **v4 (2025-01-15)**: æœ€ç»ˆç‰ˆ - å¯†ç ä¿æŠ¤ OTP seed + å¯é…ç½®ç¼“å­˜å‘¨æœŸ
- **v3 (2025-01-15)**: ä»…ä½¿ç”¨ TOTP éªŒè¯ç ï¼ˆå·²åºŸå¼ƒï¼‰
- **v2 (2025-01-15)**: å¯†ç  + TOTP åŒé‡éªŒè¯ï¼ˆå·²åºŸå¼ƒï¼‰
- **v1 (2025-01-15)**: åˆå§‹è®¾è®¡ - OTP ä½œä¸º Touch ID å åŠ ï¼ˆå·²åºŸå¼ƒï¼‰

---

## è®¸å¯è¯

æ­¤æ–‡æ¡£éµå¾ªä¸ fssh é¡¹ç›®ç›¸åŒçš„è®¸å¯è¯ã€‚
